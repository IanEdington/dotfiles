#!/usr/bin/env bash
# Bash Strict Mode: http://redsymbol.net/articles/unofficial-bash-strict-mode/
set -euo pipefail
IFS=$'\n\t'
# Bash Strict Mode

source ../bash_utils.sh

if ! command_exists brew ; then
    echo_red "could not find homebrew"
    exit 1
fi

brew update

# concatenate all Brewfiles and make sure they're installed
cd ~/.dotfiles
Brewfile_path=~/.dotfiles/.tmp/Brewfile
mkdir ~/.dotfiles/.tmp
/bin/rm $Brewfile_path
for Brewfile in ./Brewfile ./*/Brewfile ; do
    cat $Brewfile >> $Brewfile_path
done

# Install, Update, Cleanup ect.
brew bundle -v --file=$Brewfile_path
brew upgrade
brew cleanup
brew doctor

# Dump into temp folder
brew bundle dump --file=${Brewfile_path}dump-`/bin/date -ju "+%Y-%m-%d-%H%M%S"`
