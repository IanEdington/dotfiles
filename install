#!/usr/bin/env bash
# Programs are meant to be read. If you can't read this script let me know. If you have a suggestion, send a pull request, or create an issue. I love collaborating.

# install or update from git repo
dotfiles::install_from_github () {
    local package_dir github_repo starting_dir
    github_repo=$1
    package_dir=$2
    starting_dir=$PWD

    if [[ -e $package_dir ]]; then
        cd $package_dir
        git pull && git submodule update --init --remote --recursive
    else
	echo "clone into " $package_dir
        git clone --depth 1 $github_repo $package_dir
        cd $package_dir
        git submodule update --init --remote --recursive
    fi

    cd $starting_dir
}

# dotfiles::backup_func () {
    # Check that a backup folder exists
    # if not create a backup folder
    # Check if the offending file already exists in the backup folder
    # if it does
    # move the offending file into the backup folder
    # remove the file in question
    # Add the ~ relative path to the backed up files list
# }

dotfiles::symlink_files () {
    local symlink_to symlink_from
    symlink_to=$1
    symlink_from=$2

    # TODO check if link already exists

    echo "linking:" "$symlink_from" "->" "$symlink_to"

    if [ -h "$symlink_from" ]; then
        rm "$symlink_from"
    elif [ -e "$symlink_from" ]; then
        echo "$symlink_from" " exists and is not a symlink! aboart aboart!"
        echo "we aren't ready to handle this"
        return
        # TODO use the backup_func
    elif [[ ! -e "$(dirname "$symlink_from")" ]]; then
        mkdir -p "$(dirname "$symlink_from")"
    fi

    ln -s "$symlink_to" "$symlink_from"
}

# Starting the fun stuff

# ref: http://stackoverflow.com/a/246128/4301584
DOTFILES_ROOT="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd -P )"
# echo "dotfiles root " $DOTFILES_ROOT

# in case people want to use comands in their scripts
    # Add bin/ to path
    # Add homebrew bin to path

# install brew on OSX or Linux if it's not already installed
        # TODO exit if there's a problem
#    brew update
#    brew upgrade
#    brew doctor
#    brew tap homebrew/bundle
#    brew bundle

# Symlink the current folder to .dotfiles
dotfiles::symlink_files $DOTFILES_ROOT ~/.dotfiles;
cd $DOTFILES_ROOT

# for each folder in dotfiles/
for dir in */ ; do
    echo Installing the $dir directory:
    cd $dir;

    if [ -f Brewfile ]; then
        brew bundle
    fi

    if [ -f install ]; then
        source ./install
    fi

    # dotfiles::symlink_files for each *.symlink
    # append .zsh files to .zsh
    # append path.zsh files to zsh $PATH
    # append *completion.zsh to
    # append .bash files to .profile
    # append path.bash files to bash $PATH
    cd $DOTFILES_ROOT
done

# exit $?

